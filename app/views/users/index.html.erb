<%
  breadcrumb << ["系统设置", users_path]
  breadcrumb << ["用户管理", users_path]
  breadcrumb << ["用户"]
%>
<ul class="nav nav-tabs">
  <li class="active"><a href="/users">用户</a></li>
  <li><a href="/users/roles">角色</a></li>
</ul><!-- nav-tabs -->
<div class="tab-content">
<div class="tab-pane active" id="users">
<%= form_tag search_users_path, :class=>"well well-small form-horizontal font12" do %>
  <fieldset>
    <div class="controls pull-left">
      <%=select_tag "where_name", options_for_select([["用户名","username"],["姓名","name"],["邮箱","email"]]), :value => "#{params[:where_name]}" %>

      <div class="input-append">
        <%= text_field_tag "keyword", '',:value => "#{params[:keyword] if params[:keyword]}", :class => "input-medium radius_no_tl", :placeholder => "输入关键字..."%>
        <%= button_tag "过滤", :class => "btn btn-small btn-info" %>
      </div>
    </div>
  </fieldset>
<% end %>

<%= form_tag edit_with_role_users_path,:method => :post,:id => "edit_user" do %>
<div class="btn-toolbar">
  <div class="btn-group">
    <b class="btn btn-warning">操作</b>
    <button class="btn btn-warning dropdown-toggle" data-toggle="dropdown" onclick="return false">
      <span class="caret"></span>
    </button>
    <ul class="dropdown-menu">
      <li>
        <%= link_to "编辑", "#",:onclick => "validateValues(this)",:goto => edit_with_role_users_path,:request => "get" %>
      </li>
      <li>
        <%= link_to "删除","#",:onclick => "validateValues(this)",:id => "delete_users", :goto => "/users/delete",:request => "post",:confirm => "确认删除?"%>
      <li><%=link_to "开启", "#", :onclick => "validateValues(this)",:goto => "/users/batch_update?operation=unlock",:request => "post",:confirm => "确认开启吗?" %></li>
      <li>
        <%=link_to "禁用", "#",:onclick => "validateValues(this)",:goto => "/users/batch_update?operation=lock",:request => "post",:confirm => "确认禁用?"%>
    </ul>
  </div><!-- btn-group -->
  <div class="btn-group">
    <a href="/users/new" data-toggle="modal" class="btn btn-warning">新增用户</a>
  </div><!-- btn-group -->
</div><!-- btn-groups end -->

<table class="table table-hover table-bordered table-striped table-condensed js-table">
  <thead>
    <tr>
      <th width="1%"><input type="checkbox"></th>
      <th width="10%">用户名</th>
      <th width="15%">角色名称</th>
      <th width="25%">手机</th>
      <th width="25%">邮箱</th>
      <th width="10%">姓名</th>
      <th width="10%">状态</th>
    </tr>
  </thead>
  <tbody>
    <% @users.each do |user| %>
    <tr>
      <td><input type="checkbox" value="<%= user.id %>" name="user_ids[]"></td>  
      <td><%= user.username %></td>
      <td><%= user.roles.map(&:name).try(:join,',') %></td>
      <td><%= user.phone %></td>
      <td><%= user.email %></td>
      <td><%= user.name %></td>
      <td><%= user.status %></td>
    </tr>
    <% end %>
  </tbody>
</table>
<% end %>
</div></div>
<%= paginate @users %>
<script>
function validateValues(item){
  var check_values = $('input:checked').map(function(){if($(this).val() != 'on'){return ($(this).val())}});
  if($('input:checked').length < 1) {  
    alert('请选择');  
  } else if($.inArray('<%= current_user.id %>',check_values) >= 0 && $(item).attr("goto") != "/users/edit_with_role"){  
    alert('不能操作自己哦 ╮(╯_╰)╭');
  } else {
    $('#edit_user').attr({action: $(item).attr("goto") ,method: $(item).attr("request") });  
    $('#edit_user').submit();  
  }  
}
</script>
