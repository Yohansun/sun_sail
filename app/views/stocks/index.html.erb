<div class="container-fluid">
  <header class="jumbotron subhead" id="overview">
    <div class="subnav">
      <ul class="nav nav-pills">
        <li class="active"><%= link_to '仓库管理', seller_stocks_path %></li>
        <li ><a href="<%=stock_products_path%>">库存查询</a></li>
        <!-- <li><%#= link_to '进销记录', ''%></li> -->
      </ul>
    </div>
  </header>
  <div class="row-fluid">
    <ul class="breadcrumb" style="position:relative;">
      <li>
        <%= link_to 'Magic', root_path %>
        <span class="divider">/</span>
      </li>
      <li class="active"><%= @seller.try(:name) %></li>
      <li style="position:absolute;right:15px;top:6px;">
        <%= link_to '新增商品', new_seller_stock_product_path, class: 'btn_alert' %>
      </li>
    </ul><!-- breadcrumb -->

    <%= simple_form_for "product",  url: seller_stocks_path(@seller), html: { method: "get", class: "well form-horizontal reset_space"}, :wrapper => :search do |f| %>
      <fieldset>
        <div class="control-group form-inline">
          <div class="pull-left mar_r10">
            <label class="control-label width_auto">库存状态：</label>
            <label class="radio pad_t5">
              <input type="radio" name="stock_state" value="usual" <%= 'checked' if params[:stock_state] == 'usual' %>>正常
            </label>
            <label class="radio pad_t5">
              <input type="radio" name="stock_state" value="max" <%= 'checked' if params[:stock_state] == 'max' %>>满仓
            </label>
            <label class="radio pad_t5">
              <input type="radio" name="stock_state" value="safe" <%= 'checked' if params[:stock_state] == 'safe' %>>预警
            </label>
          </div>
          
          <div class="pull-left mar_r10">
            <select class="width_auto" name='info_type'>
              <option value="outer_id" <%= 'selected' if params[:info_type] == 'outer_id' %>>商品编码</option>
              <option value="product_id" <%= 'selected' if params[:info_type] == 'product_id' %>>淘宝ID</option>
              <option value="name" <%= 'selected' if params[:info_type] == 'name' %>>商品名称</option>
              <option value="sku_info" <%= 'selected' if params[:info_type] == 'sku_info' %>>商品属性</option>
            </select>
            <input type="text" name="info" class="input-large" value='<%= params[:info] %>'>
          </div>
      
        
          <div class="pull-left mar_r10">
            <fieldset class="form-inline">
              <label class="control-label width_auto">商品分类：</label>
              <select class="width_auto" name="category">
                <option value="0" <%= 'selected' if params[:category] == '0' %>>全部</option>
                <%- Category.all.each do |category| %>
                  <option value="<%= category.id %>" <%= 'selected' if params[:category] == category.id %>><%= category.name %></option>
                <%- end %>
              </select> 
            </fieldset>                            
          </div>
               
          <button type="submit" class="btn btn-primary">筛选</button>
          <a class="btn">重置</a>
        </div>
      </fieldset>
    <%- end %>
    <div style="margin:5px 0px 10px;height:350px;overflow-y:auto;">
      <div id="chartdiv" style="width: 100%;"></div>
    </div>

    <table class="table table-striped table-bordered table-condensed vertical_mid">
      <thead>
        <tr>
        <!--   <th>图片</th> -->
          <th>名称</th>
          <th>商品属性</th>
          <th>分类</th>
          <th>商品编码</th>
          <th>库存状态</th>
          <th>可用库存</th>
          <th>实际库存</th>
          <th>安全库存</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <% @stock_products.each do |stock_product| %>
        <tr>
       <!-- <td></td> -->
          <td><%= stock_product.name %></td>
          <td><%= stock_product.sku_name %></td>
          <td><%= stock_product.product.try(:category).try(:name) %></td>
          <td><%= stock_product.product.outer_id %></td>
          <td><%= stock_product.storage_status %></td>
          <td><%= stock_product.activity %></td>
          <td><%= stock_product.actual %></td>
          <td><%= stock_product.safe_value %></td>
          <td>
            <div class="btn-group">
              <button data-toggle="dropdown" class="btn btn-info dropdown-toggle min_w">
                <i class="icon-wrench"></i>
                <span class="caret"></span>
              </button>
              <ul class="dropdown-menu trade_pops" style="left:-115px;">
                <li><a href='javascript:void(0)' onclick='show_storage_in(<%= stock_product.id %>)' >入库</a></li>
                <li><a href='javascript:void(0)' onclick='show_storage_out(<%= stock_product.id %>)'>出库</a></li>
                <li><%= link_to '进销记录', seller_stock_product_stock_history_index_path(params[:seller_id], stock_product.id) %></li>
                <li><%= link_to '编辑', edit_seller_stock_product_path(params[:seller_id], stock_product.id) %></li>
                <li>
                  <%= link_to '删除', seller_stock_product_path(params[:seller_id], stock_product.id), method: :delete, confirm: '确认删除?' %>
                </li>
              </ul>
            </div>
          </td>
        </tr>
        <% end %>
      </tbody>
    </table>

    <%= paginate @stock_products %>
  </div>
</div>

<%= form_tag '', id: 'storage_in', class: 'form-horizontal modal hide fade', remote: true %>
  <input type='hidden' class='modal_product_id' name='stock_history[stock_product_id]'>
  <input type='hidden' class='modal_product_operation' name='stock_history[operation]' value='入库'>
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">×</button>
    <h4>入库操作</h4>
  </div>
  <div class="modal-body">
    <fieldset>
      <div class="control-group">
        <label class="control-label" for="">商品名称：</label>
        <div class="controls">
          <span class="input-xlarge uneditable-input modal_product_name"></span>
        </div>
      </div>

      <div class="control-group">
        <label class="control-label" for="">实际库存：</label>
        <div class="controls">
          <span class="input-xlarge uneditable-input modal_product_actual"></span>
        </div>
      </div>

      <div class="control-group">
        <label class="control-label" for="">可用库存：</label>
        <div class="controls">
          <span class="input-xlarge uneditable-input modal_product_activity"></span>
        </div>
      </div>

      <div class="control-group">
        <label class="control-label" for="">*入库数量：</label>
        <div class="controls">
          <input type="text" class="input-small" name="stock_history[number]">件
        </div>
      </div>

      <div class="control-group">
        <label class="control-label" for="">入库原因：</label>
        <div class="controls">
          <select class="width_auto" name='stock_history[reason]'>
            <option value='i1'>生产入库</option>
            <option value='i0'>双十一备货库存</option>
            <option value='i0'>其他原因</option>
          </select>
        </div>
      </div>

      <div class="control-group">
        <label class="control-label" for="">备注：</label>
        <div class="controls">
          <input type="text" class="input-xlarge" name='stock_history[note]'>
        </div>
      </div>
    </fieldset>
  </div>
  <div class="modal-footer">
    <button type='submit' class="btn btn-primary">确定</button>
  </div>
</form>

<%= form_tag "", id: 'storage_out', class: 'form-horizontal modal hide fade', remote: true %>
  <input type='hidden' class='modal_product_id' name='stock_history[stock_product_id]'>
  <input type='hidden' class='modal_product_operation' name='stock_history[operation]' value='出库'>
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">×</button>
    <h4>出库操作</h4>
  </div>
  <div class="modal-body">
    <fieldset>
      <div class="control-group">
        <label class="control-label" for="">商品名称：</label>
        <div class="controls">
          <span class="input-xlarge uneditable-input modal_product_name"></span>
        </div>
      </div>

      <div class="control-group">
        <label class="control-label" for="">实际库存：</label>
        <div class="controls">
          <span class="input-xlarge uneditable-input modal_product_actual"></span>
        </div>
      </div>

      <div class="control-group">
        <label class="control-label" for="">可用库存：</label>
        <div class="controls">
          <span class="input-xlarge uneditable-input modal_product_activity"></span>
        </div>
      </div>

      <div class="control-group">
        <label class="control-label" for="">*出库数量：</label>
        <div class="controls">
          <input type="text" class="input-small" name="stock_history[number]">件
        </div>
      </div>

      <div class="control-group">
        <label class="control-label" for="">出库原因：</label>
        <div class="controls">
          <select class="width_auto" name='stock_history[reason]'>
            <option value='o1'>销售出库</option>
            <option value='o0'>其他原因</option>
          </select>
        </div>
      </div>

      <div class="control-group">
        <label class="control-label" for="">备注：</label>
        <div class="controls">
          <input type="text" class="input-xlarge" name='stock_history[note]'>
        </div>
      </div>
    </fieldset>
  </div>
  <div class="modal-footer">
    <button type='submit' class="btn btn-primary">确定</button>
  </div>
</form>

<script type="text/javascript">
  function show_storage_in(id) {
    $.get('/sellers/<%= params[:seller_id]%>/stock_products/' + id, {}, function(data){
      $('#storage_in .modal_product_id').val(id)
      $('#storage_in .modal_product_name').text(data.name)
      $('#storage_in .modal_product_actual').text(data.actual)
      $('#storage_in .modal_product_activity').text(data.activity)
      $('#storage_in').attr('action', '/sellers/<%= params[:seller_id]%>/stock_products/' + id + '/stock_history')
      $('#storage_in').modal('show')
    })
  }

  function show_storage_out(id) {
    $.get('/sellers/<%= params[:seller_id]%>/stock_products/' + id, {}, function(data){
      $('#storage_out .modal_product_id').val(id)
      $('#storage_out .modal_product_name').text(data.name)
      $('#storage_out .modal_product_actual').text(data.actual)
      $('#storage_out .modal_product_activity').text(data.activity)
      $('#storage_out').attr('action', '/sellers/<%= params[:seller_id]%>/stock_products/' + id + '/stock_history')
      $('#storage_out').modal('show')
    })
  }
</script>
<%- content_for :tail do %>
<script type="text/javascript">
var chart;
var chartData = []
<%- @stock_products.each do |stock_product| %>
  chartData.push({commodity: "<%= stock_product.product.outer_id %>", stock_infact: "<%= stock_product.actual %>", stock_safe: "<%= stock_product.safe_value %>", stock_safe_end: "<%= stock_product.safe_value %>", stock_avaliable: "<%= stock_product.activity %>"})


  AmCharts.ready(function () {
      $('#chartdiv').height(chartData.length * 30 + 100)
        // SERIAL CHART
        chart = new AmCharts.AmSerialChart();
        chart.dataProvider = chartData;
        chart.pathToImages = "/assets/amcharts_images/";
        chart.categoryField = "commodity";
        chart.marginTop = 20;
        chart.rotate = true;
        // chart.startDuration = 1;
        // chart.angle = 30;
        // chart.depth3D = 45;
        // chart.addListener("dataUpdated", zoomChart);

        // AXES
        // category
        var categoryAxis = chart.categoryAxis;
        // categoryAxis.title = "数量";
        // categoryAxis.titleColor = "#555555";
        categoryAxis.gridAlpha = 0.15;
        categoryAxis.axisAlpha = 0;
        // categoryAxis.autoGridCount = false;
        // categoryAxis.equalSpacing = true;
        // categoryAxis.labelRotation = 60;
        categoryAxis.gridPosition = "start";

        // value                        
        var valueAxis = new AmCharts.ValueAxis();
        valueAxis.stackType = "3d"; // this line makes the chart regular stacked
        valueAxis.gridAlpha = 0.15;
        valueAxis.axisAlpha = 0;
        valueAxis.autoGridCount = true;
        // valueAxis.labelsEnabled = false;
        chart.addValueAxis(valueAxis);

        // GRAPHS
        // stock_safe graph              
        var graph = new AmCharts.AmGraph();
        graph.title = "安全值";
        // graph.labelText = "[[value]]";
        graph.balloonText = "<%= stock_product.name %> 安全库存: [[value]]";
        // graph.valueField = "stock_safe";
        graph.type = "column";//graph.type = "line";//graph.type = "step";
        graph.lineAlpha = 1;//graph.lineAlpha = 1;
        graph.fillAlphas = 1;
        graph.valueField = "stock_safe";
        graph.openField = "stock_safe_end";
        graph.lineThickness = 3;
        // graph.bullet = "round";
        graph.lineColor = "#F05D22";
        chart.addGraph(graph);
        // stock_avaliable graph              
        var graph = new AmCharts.AmGraph();
        graph.title = "可用库存";
        // graph.labelText = "[[value]]";
        graph.balloonText = "<%= stock_product.name %> 可用库存: [[value]]";
        graph.valueField = "stock_avaliable";
        graph.type = "column";
        graph.lineAlpha = 0;
        graph.fillAlphas = 1;
        graph.lineColor = "#3D9ED5";
        chart.addGraph(graph);
        // stock_infact graph                          
        var graph = new AmCharts.AmGraph();
        graph.title = "实际库存";
        // graph.labelText = "[[value]]";
        graph.balloonText = "<%= stock_product.name %> 实际库存: [[value]]";
        graph.valueField = "stock_infact";
        graph.type = "column";
        graph.lineAlpha = 0;
        graph.fillAlphas = 1;
        graph.lineColor = "#FDD900";
        chart.addGraph(graph);


        // LEGEND                  
        var legend = new AmCharts.AmLegend();
        legend.borderAlpha = 0.2;
        legend.position = "top";
        legend.horizontalGap = 10;
        legend.autoMargins = true;
        legend.marginLeft = 20;
        legend.marginRight = 20;
        legend.switchType = "v";
        chart.addLegend(legend);
        // SCROLLBAR
        // var chartScrollbar = new AmCharts.ChartScrollbar();
        // chart.addChartScrollbar(chartScrollbar);

        // WRITE                  
        chart.write("chartdiv");

        // function zoomChart() {
                // different zoom methods can be used - zoomToIndexes, zoomToDates, zoomToCategoryValues
                // chart.zoomToDates(new Date(2012, 9, 25, 0), new Date(2012, 9, 25, 2));
                // chart.zoomToIndexes(chartData.length - 9, chartData.length - 1);
              // }
    });

    // this method makes chart 2D/3D
    /*function setDepth() {
        if (document.getElementById("rb1").checked) {
            chart.depth3D = 0;
            chart.angle = 0;
        } else {
            chart.depth3D = 25;
            chart.angle = 30;
        }
        chart.validateNow();
    }*/
  <%- end %>
</script>
<%- end %>
