<div class="container-fluid">
  <div class="row-fluid">
    <%= render "nav" %>
    <form ation="/trades_reports" class="well form-horizontal">
      <div class="control-group nomargin">
        <%= render :partial => "search",:locals => {:path => customers_path} %>
      </div>
    </form>
    <div class="btn-toolbar">
      <div class="btn-group">
        <button class="btn btn-warning">操作</button>
        <button class="btn btn-warning dropdown-toggle" data-toggle="dropdown">
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <li>
            <%= link_to "导出","#",:onclick => "exportChecked('#{format_url(:xls)}')" %>
          </li>
          <li>
            <%= link_to_authorize "发送短信","#",:target_url => "/customers/send_messages",:request => "get",:class => "magic_operation"%>
          </li>
          <li>
            <%= link_to_authorize "详细", "#",:target_url => "/customers",:class => "magic_detail"%>
          </li>
        </ul>
      </div>
    </div>
    <%= form_tag "",:id => "customers",:class => "simple-operation" do %>
    <%= hidden_field_tag "product_ids",@product_ids.join(',') rescue "" %>
      <table class="table table-striped table-bordered mar_t10">
        <thead>
        <th><input id="checkbox_all" type="checkbox" value="option1"></th>
        <th>顾客ID</th>
        <th width="88px">联系电话</th>
        <th width="200px">顾客邮箱</th>
        <th>订单编号</th>
        <th>购买商品</th>
        <th>商品生命周期</th>
        <th>省</th>
        <th>市</th>
        <th>区</th>
        <th>地址</th>
        </thead>
        <tbody>
        <% @customers.each_with_index do |customer| %>
          <%- if customer.product_trades.present? -%>
            <%
               col_num = customer.product_trades.sum{|trade| (trade.product_ids & @product_ids rescue trade.product_ids).size}
            %>
            <%- customer.product_trades.each_with_index do |trade, t_idx| -%>
              <%- (trade.product_ids & @product_ids rescue trade.product_ids).each_with_index do |product_id, p_idx| -%>
                <tr class="export_excel">
                  <%- if t_idx == 0 && p_idx == 0 %>
                    <td rowspan="<%= col_num%>"><%= check_box_tag "search[_id_in][]",customer.id %></td>
                    <td rowspan="<%= col_num%>"><%= customer.name %></td>                <!--Newly Add-->
                    <td rowspan="<%= col_num%>"><%= customer.receiver_mobile %></td>
                    <td rowspan="<%= col_num%>"><%= customer.email %></td>
                  <%- end -%>
                  <%- if p_idx == 0 -%>
                    <td rowspan="<%= trade.product_ids.length%>"><%= trade.tid %></td>
                  <%- end -%>
                  <td><%= product(@products,product_id).name rescue "" %></td>
                  <td><%= product(@products,product_id).category.use_days rescue "" %>天
                    <%- if t_idx == 0 && p_idx == 0 %>
                    <td rowspan="<%= col_num%>"><%= customer.receiver_state %></td>
                    <td rowspan="<%= col_num%>"><%= customer.receiver_city %></td>
                    <td rowspan="<%= col_num%>"><%= customer.receiver_district %></td>
                    <td rowspan="<%= col_num%>"><%= customer.receiver_address %></td>
                  <%- end -%>
                </tr>
              <%- end -%>
            <%- end -%>
          <%- else -%>
            <tr>
              <td><%= check_box_tag "search[_id_in][]",customer.id %></td>
              <td><%= customer.name %></td>                <!--Newly Add-->
              <td><%= customer.receiver_mobile %></td>
              <td><%= customer.email %></td>
              <td></td>
              <td></td>
              <td></td>
              <td><%= customer.receiver_state %></td>
              <td><%= customer.receiver_city %></td>
              <td><%= customer.receiver_district %></td>
              <td><%= customer.receiver_address %></td>
            </tr>
          <%- end -%>
        <% end %>
        </tbody>
      </table>
    <% end %>
  </div>
  <%= paginate @customers %>
</div>